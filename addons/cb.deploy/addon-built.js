define("client",[],function(){var e=codebox.require("q"),t=codebox.require("underscore"),n=codebox.require("utils/dialogs"),r=codebox.require("core/box"),i=codebox.require("core/backends/rpc"),s=codebox.require("models/command"),o=codebox.require("core/commands/menu"),u=codebox.require("core/user"),a=codebox.require("vendors/crypto"),f=u.settings("deploymentSolutions"),l=function(){return i.execute("project/deployment/solutions")},c=function(e){return l().then(function(n){var r=t.find(n,function(t){return t.id==e});if(!r)throw"Invalid solution type";return r})},h=function(e){return a.MD5(e).toString()},p=function(t,n){var r=f.get("solutions",{}),i=h(t);return r[i]?e.reject("Solution already exists"):(r[i]={name:t,type:n,settings:{}},f.set("solutions",r),E(),f.save().then(function(){return r[i]}))},d=function(t){var n=f.get("solutions",{});return n[t]?(delete n[t],f.set("solutions",n),E(),f.save()):e.reject("Invalid solution")},v=function(e){var t=f.get("solutions",{});return t[e]},m=function(e,t){var n=f.get("solutions",{});n[e].settings=t,f.set("solutions",n)},g=function(e){var r=v(e);return c(r.type).then(function(e){return n.fields("Configuration for "+t.escape(r.name),e.settings,r.settings)}).then(function(t){return m(e,t),f.save()})},y=s.register("deploy.solutions.add",{title:"Add Solution",offline:!1,action:function(e){l().then(function(e){return n.fields("Add Deployment Solution",{name:{type:"text",label:"Label"},solution:{type:"select",label:"Type",options:t.object(t.map(e,function(e){return[e.id,e.name]}))}})}).then(function(e){if(!e.name||!e.solution)throw"Need 'name' and 'solution'";return p(e.name,e.solution)}).then(function(e){return g(h(e.name))})}}),b=s.register("deploy.solutions.remove",{title:"Remove Solution",offline:!1,action:function(){n.select("Remove Deployment Dolution","Select a solution, this solution and its configuration will be removed from your settings.",t.chain(f.get("solutions",{})).map(function(e,t){return[t,e.name]}).object().value()).then(d)}}),w=o.register("deploy",{title:"Deploy",position:90}),E=function(){return l().then(function(e){var n=f.get("solutions",{});w.clearMenu(),w.menuSection(t.compact([y,t.size(n)>0?b:null]));if(t.size(n)==0)return;w.menuSection(t.chain(n).map(function(n){var r=t.find(e,function(e){return e.id==n.type});if(!r)return null;var i=s.register({title:n.name,type:"menu",offline:!1,action:function(){g(h(n.name))}});return i.menuSection(t.map(r.actions,function(e){return{title:e.name,offline:!1,action:function(){alert("do "+e.id)}}})),i.menuSection([{title:"Configure",offline:!1,action:function(){g(h(n.name))}}]),i}).compact().value())})};E()})